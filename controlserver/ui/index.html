<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zero Trust CPS UI</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f7fa;
      color: #333;
    }
    header {
      background: #007bff;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      margin: 0 0 10px 0;
      font-size: 2rem;
    }
    nav {
      margin-top: 10px;
    }
    nav button {
      background: #0056b3;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 0 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }
    nav button:hover {
      background: #003d80;
    }
    .logout-btn {
      background: #dc3545 !important;
    }
    .logout-btn:hover {
      background: #b02a37 !important;
    }
    main {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
      text-align: center;
    }
    .card h2 {
      margin: 0;
      font-size: 1.2rem;
      color: #666;
    }
    .card p {
      font-size: 2rem;
      margin: 10px 0 0;
    }
    .unit {
      font-size: 1rem;
      color: #999;
    }
    .actions {
      text-align: center;
      margin-top: 30px;
    }
    .actions button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 12px 25px;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .actions button:hover {
      background: #0056b3;
    }
    label {
      display: block;
      margin: 20px 0 10px;
      font-weight: bold;
    }
    select, input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
    }
    #response {
      margin-top: 20px;
      font-weight: bold;
      color: green;
      text-align: center;
    }
    .error {
      color: red !important;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #007bff;
      color: #fff;
    }
    tr:hover {
      background: #f1f1f1;
    }
    footer {
      text-align: center;
      font-size: 0.9rem;
      color: #999;
      margin: 40px 0;
    }
    .login-container {
      max-width: 400px;
      margin: 50px auto;
    }
    .login-card {
      padding: 20px;
    }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="login" class="section active">
    <div class="login-container">
      <div class="card login-card">
        <h2>Zero Trust Authentication</h2>
        <div>
          <label for="login-username">Username:</label>
          <input type="text" id="login-username" placeholder="Enter username"/>
          <label for="login-password">Password:</label>
          <input type="password" id="login-password" placeholder="Enter password"/>
          <button onclick="performLogin()" class="actions">Login</button>
          <div id="login-error" class="error"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="app" class="section">
    <header>
      <h1 id="ui-heading">Zero Trust CPS UI</h1>
      <nav>
        <button onclick="showSection('dashboard')">Dashboard</button>
        <button id="control-btn" onclick="showSection('control')">Control Panel</button>
        <button id="logs-btn" onclick="showSection('logs')">Audit Logs</button>
        <button onclick="logout()" class="logout-btn">Logout</button>
      </nav>
    </header>

    <main>
      <!-- Dashboard Section -->
      <div id="dashboard" class="section active">
        <div class="grid">
          <div class="card">
            <h2>Temperature</h2>
            <p id="temp-value">--</p>
            <span class="unit">Â°C</span>
          </div>
          <div class="card">
            <h2>Pressure</h2>
            <p id="pressure-value">--</p>
            <span class="unit">bar</span>
          </div>
          <div class="card">
            <h2>Voltage</h2>
            <p id="voltage-value">--</p>
            <span class="unit">V</span>
          </div>
          <div class="card">
            <h2>Actuator Status</h2>
            <p id="actuator-status">--</p>
          </div>
        </div>
        <div class="actions">
          <button onclick="refreshDashboard()">Refresh Data</button>
        </div>
      </div>

      <!-- Control Panel Section -->
      <div id="control" class="section">
        <h2>Manual Actuator Control</h2>
        <label for="action-select">Select Action:</label>
        <select id="action-select">
          <option value="">-- Choose an action --</option>
          <option value="toggle">Toggle Actuator</option>
        </select>
        <div class="actions">
          <button onclick="submitCommand()">Submit Command</button>
        </div>
        <div id="response"></div>
      </div>

      <!-- Audit Logs Section -->
      <div id="logs" class="section">
        <h2>System Activity Logs</h2>
        <p class="log-count" id="log-count">Loading logs...</p>
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Action</th>
              <th>Operator</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="logs-body"></tbody>
        </table>
        <div class="actions">
          <button onclick="loadLogs()">Refresh Logs</button>
        </div>
      </div>
    </main>

    <footer>
      &copy; 2025 Zero Trust CPS Project | All Rights Reserved
    </footer>
  </div>

  <script>
    let currentToken = null;
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById('login').classList.add('active');
    });

    function performLogin() {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      const errorElement = document.getElementById('login-error');

      errorElement.textContent = '';

      if (!username || !password) {
        errorElement.textContent = 'Please enter both username and password';
        return;
      }

      fetch("http://localhost:5000/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      })
      .then(response => {
        if (!response.ok) throw new Error("Login failed");
        return response.json();
      })
      .then(data => {
        currentToken = data.token;
        currentUser = data.user;

        const heading = document.getElementById('ui-heading');
        const controlBtn = document.getElementById('control-btn');
        const logsBtn = document.getElementById('logs-btn');

        if (currentUser.role === 'admin') {
          heading.textContent = "Zero Trust CPS Admin UI";
          controlBtn.style.display = 'inline-block';
          logsBtn.style.display = 'inline-block';
        } else {
          heading.textContent = "Zero Trust CPS Operator UI";
          controlBtn.style.display = 'none';
          logsBtn.style.display = 'none';
        }

        document.getElementById('login').classList.remove('active');
        document.getElementById('app').classList.add('active');
        document.getElementById('dashboard').classList.add('active');

        refreshDashboard();
      })
      .catch(error => {
        errorElement.textContent = "Invalid credentials. Please try again.";
        console.error("Login error:", error);
      });
    }

    function logout() {
      currentToken = null;
      currentUser = null;
      document.getElementById('app').classList.remove('active');
      document.getElementById('login').classList.add('active');
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      document.querySelectorAll('#app .section').forEach(sec => sec.classList.remove('active'));
      // Reset nav buttons for next login
      document.getElementById('control-btn').style.display = 'inline-block';
      document.getElementById('logs-btn').style.display = 'inline-block';
    }

    function showSection(sectionId) {
      if (!currentToken) {
        alert("Please login first");
        return;
      }
      document.querySelectorAll('#app .section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      if (sectionId === 'logs') loadLogs();
    }

    function validateToken() {
      if (!currentToken) return Promise.reject("No token");
      return fetch("http://localhost:5000/validate", {
        method: "POST",
        headers: { "Authorization": `Bearer ${currentToken}` }
      }).then(res => {
        if (!res.ok) throw new Error("Token validation failed");
        return res.json();
      });
    }

    function fetchWithAuth(url, options = {}) {
      if (!currentToken) return Promise.reject("Not authenticated");
      const headers = { ...options.headers, "Authorization": `Bearer ${currentToken}` };
      return fetch(url, { ...options, headers });
    }

    function refreshDashboard() {
      fetchWithAuth("http://localhost:5001/read").then(res => res.json()).then(data => {
        document.getElementById("temp-value").textContent = data.temperature ?? '--';
      }).catch(() => document.getElementById("temp-value").textContent = 'ERR');

      fetchWithAuth("http://localhost:5002/read").then(res => res.json()).then(data => {
        document.getElementById("pressure-value").textContent = data.pressure ?? '--';
      }).catch(() => document.getElementById("pressure-value").textContent = 'ERR');

      fetchWithAuth("http://localhost:5003/read").then(res => res.json()).then(data => {
        document.getElementById("voltage-value").textContent = data.voltage ?? '--';
      }).catch(() => document.getElementById("voltage-value").textContent = 'ERR');

      fetchWithAuth("http://localhost:5004/status").then(res => res.json()).then(data => {
        document.getElementById("actuator-status").textContent = data.status ?? '--';
      }).catch(() => document.getElementById("actuator-status").textContent = 'ERR');
    }

    function submitCommand() {
      if (!currentToken) {
        alert("Please login first");
        return;
      }
      const action = document.getElementById('action-select').value;
      const responseElement = document.getElementById('response');
      if (!action) {
        alert("Please select an action.");
        return;
      }
      responseElement.textContent = "Processing...";
      validateToken().then(() => {
        if (action === "toggle") {
          return fetchWithAuth("http://localhost:5004/toggle", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
        }
      }).then(res => {
        if (!res.ok) throw new Error("Command failed");
        return res.json();
      }).then(() => {
        responseElement.textContent = "Command executed successfully!";
        refreshDashboard();
      }).catch(err => {
        responseElement.textContent = "Error: " + err.message;
      });
    }

    function loadLogs() {
      const mockLogs = [
        {
          timestamp: new Date().toISOString(),
          action: "System initialized",
          operator: "system",
          details: "Zero Trust CPS started"
        },
        {
          timestamp: new Date(Date.now() - 100000).toISOString(),
          action: "Actuator toggled",
          operator: currentUser?.username || "unknown",
          details: "Actuator state changed to ON"
        }
      ];
      const tbody = document.getElementById("logs-body");
      tbody.innerHTML = "";
      mockLogs.forEach(log => {
        tbody.innerHTML += `<tr>
          <td>${new Date(log.timestamp).toLocaleString()}</td>
          <td>${log.action}</td>
          <td>${log.operator}</td>
          <td>${log.details}</td>
        </tr>`;
      });
      document.getElementById("log-count").textContent = `${mockLogs.length} logs loaded`;
    }
  </script>
</body>
</html>
